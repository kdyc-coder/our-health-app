import streamlit as st
import pandas as pd
from datetime import datetime

# --- CONFIGURATION & AUSSIE PERSONA ---
st.set_page_config(page_title="Tai Chi Walker", page_icon="üéã")

# --- CUSTOM CSS FOR "APP LIKE" FEEL ---
st.markdown("""
<style>
    .big-font { font-size:20px !important; }
    .success { color: #2e7d32; font-weight: bold; }
    .warning { color: #d32f2f; font-weight: bold; }
</style>
""", unsafe_allow_html=True)

# --- ACCOUNTABILITY LOGIC ---
def get_feedback(current_weight, start_weight, last_week_weight):
    if current_weight < last_week_weight:
        return "üåü Bloody legend! You're trending down. The Tai Chi is working. Keep it up!"
    elif current_weight == last_week_weight:
        return "ü§úü§õ Flatline. Not bad, but let's tighten up the diet this week. You've got this."
    elif current_weight > last_week_weight:
        return "üõë Hold your horses. The scales went the wrong way. Check the meal plan‚Äîno sneaking bikkies. Let's get back on track right now."
    else:
        return "Welcome! Let's get some stats in."

# --- MAIN APP ---
def main():
    st.title("üéã Tai Chi Walk & Metabolic Health")
    st.write("Over 50s | Low Impact | Diabetes Remission Focus")

    # User Selection
    user = st.radio("Who is checking in?", ["Partner (Plantar Fasciitis)", "You"])
    
    # --- VITALS TRACKER ---
    st.header(f"G'day, {user}")
    
    with st.expander("üìù Log Today's Vitals", expanded=True):
        col1, col2 = st.columns(2)
        with col1:
            weight = st.number_input("Current Weight (kg)", min_value=40.0, max_value=200.0, step=0.1)
            bp_sys = st.number_input("BP Systolic (Top)", min_value=80, max_value=220)
        with col2:
            bp_dia = st.number_input("BP Diastolic (Bottom)", min_value=40, max_value=120)
            blood_sugar = st.number_input("Fasting Glucose (mmol/L)", min_value=0.0, step=0.1)
        
        # Simple Logic for Weight Loss Projection (Calorie Deficit Estimate)
        if st.button("Calculate Projection"):
            # BMR Estimate (Mifflin-St Jeor rough avg for >50)
            daily_burn = 1800  # Placeholder average
            deficit = 500 # Aiming for manageable loss
            loss_per_week = (deficit * 7) / 7700 # ~7700 cals in 1kg fat
            
            st.info(f"üìâ At a safe pace, you can expect to lose approx **{loss_per_week:.2f} kg per week**.")
            
            # Simulated previous data for the "Feedback" logic
            # In a real app, you'd pull this from a database
            last_week_mock = weight + 0.5 
            feedback = get_feedback(weight, weight+5, last_week_mock)
            st.markdown(f"<p class='big-font'>{feedback}</p>", unsafe_allow_html=True)

            if bp_sys > 130 or bp_dia > 85:
                st.warning("‚ö†Ô∏è BP is elevated. Remember: Slow, deep breathing during Tai Chi drops cortisol.")
            else:
                st.success("‚úÖ BP is looking good mate!")

    # --- TAI CHI WALKING GUIDE ---
    st.divider()
    st.header("üßò Tai Chi Walking (Joint Safe)")
    
    st.info("üí° **Focus:** Heel-to-toe rolling. Do not stomp.")
    
    tab1, tab2 = st.tabs(["Walking Technique", "Pain Management"])
    
    with tab1:
        st.write("""
        * **The Roll:** Land softly on the heel, roll through the arch, push off the big toe.
        * **The Knees:** Keep them "soft" (slightly bent). Never lock your knees back.
        * **The Hips:** Imagine your pelvis is a bowl of water‚Äîdon't spill it. Keep it level.
        """)
        
    with tab2:
        if user == "Partner (Plantar Fasciitis)":
            st.warning("ü¶∂ **Plantar Alert:** Stretching calves BEFORE walking is non-negotiable. If the heel hurts, shorten your stride.")
        else:
            st.write("üõ°Ô∏è **Hip Saver:** Keep your feet shoulder-width apart. Walking on a 'tightrope' hurts the hips.")

    # --- MEAL PLANNER & SHOPPING LIST ---
    st.divider()
    st.header("ü•ë Diabetes Remission Meal Plan")
    
    diet_type = st.selectbox("Choose Plan Strategy:", ["Low Carb / Keto (Fast Results)", "Mediterranean (BP Focus)"])
    
    if st.button("Generate Shopping List"):
        st.write(f"**Plan: {diet_type}**")
        
        if "Keto" in diet_type:
            st.write("Focus: High healthy fat, moderate protein, near-zero sugar.")
            shopping = {
                "Produce": ["Spinach", "Avocados (lots)", "Zucchini", "Cauliflower"],
                "Protein": ["Salmon (Omega-3s)", "Eggs", "Chicken Thighs"],
                "Pantry": ["Olive Oil", "Almonds", "Apple Cider Vinegar"]
            }
        else:
            st.write("Focus: Whole grains, legumes, fish, tons of veggies.")
            shopping = {
                "Produce": ["Tomatoes", "Cucumber", "Leafy Greens", "Berries"],
                "Protein": ["White Fish", "Lentils", "Greek Yoghurt"],
                "Pantry": ["Extra Virgin Olive Oil", "Walnuts", "Quinoa"]
            }
            
        st.table(pd.DataFrame(dict([ (k,pd.Series(v)) for k,v in shopping.items() ])))
        st.caption("Tip: Screenshot this list for your shop!")

if __name__ == "__main__":
    main()